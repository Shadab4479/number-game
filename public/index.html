<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Number Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #ff4757; --safe: #2ecc71; --dark: #1e272e; --glass: rgba(255, 255, 255, 0.1); }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #1e272e;
            color: white;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: background 0.5s ease;
        }

        /* Green Highlight for Active Turn */
        body.my-turn-bg {
            background: #054d24 !important; /* Dark Green */
        }

        .container {
            width: 90%; max-width: 500px;
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Floating Button */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            background: #ffa502;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 100;
        }

        /* Modal Scoreboard */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 200; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #2f3640; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px;
        }

        /* Game Elements */
        input, select, button {
            width: 80%; padding: 12px; margin: 10px 0;
            border-radius: 8px; border: none; font-size: 16px;
        }
        button { background: var(--primary); color: white; cursor: pointer; font-weight: bold; }
        
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 20px; }
        .cell {
            background: rgba(255,255,255,0.1); padding: 15px 0;
            border-radius: 5px; cursor: pointer;
        }
        .cell.selected { border: 2px solid #ffa502; background: rgba(255,165,2,0.2); }
        .cell.safe-cut { background: var(--safe); color: #000; font-weight: bold; pointer-events: none; }
        .cell.normal-cut { background: #555; opacity: 0.3; pointer-events: none; }

        .hidden { display: none; }
        .turn-indicator { font-size: 1.2rem; margin-bottom: 10px; font-weight: bold; }
        #timer { font-size: 2.5rem; color: #ff4757; }
    </style>
</head>
<body>

    <div class="fab" onclick="toggleScoreboard()">üèÜ</div>

    <div id="score-modal" class="modal" onclick="toggleScoreboard()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>üèÜ Leaderboard (Losses)</h2>
            <ul id="scoreboard-list" style="list-style: none; padding: 0;"></ul>
            <button onclick="toggleScoreboard()">Close</button>
        </div>
    </div>

    <div class="container">
        <div id="menu-screen">
            <h1>ESCAPE THE GRID üèÉ‚Äç‚ôÇÔ∏è</h1>
            <p>If your number is cut, you are SAFE!</p>
            <input type="text" id="username" placeholder="Enter Your Name">
            <button onclick="createRoomMenu()">Create Room</button>
            <button onclick="joinRoomMenu()">Join Room</button>
        </div>

        <div id="join-input-screen" class="hidden">
            <input type="number" id="room-code-input" placeholder="Room Code">
            <button onclick="joinRoom()">Enter</button>
        </div>

        <div id="lobby-screen" class="hidden">
            <h2>Room Code: <span id="display-room-code" style="color:#ffa502"></span></h2>
            <div id="host-controls" class="hidden">
                <select id="grid-range">
                    <option value="20">1 to 20</option>
                    <option value="30">1 to 30</option>
                </select>
                <button onclick="setGameRange()">Confirm Grid</button>
            </div>
            <p id="lobby-status">Waiting for host...</p>
        </div>

        <div id="secret-screen" class="hidden">
            <h2>Pick Secret Number ü§´</h2>
            <div id="secret-grid" class="grid"></div>
            <button id="start-btn" class="hidden" onclick="triggerStartGame()">START GAME</button>
        </div>

        <div id="game-screen" class="hidden">
            <div id="timer">15</div>
            <div class="turn-indicator" id="turn-msg">Game Starting...</div>
            <div id="main-grid" class="grid"></div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let myRoomId = null;
        let myName = "";
        let myId = null;

        // --- UI TOGGLES ---
        function toggleScoreboard() {
            const modal = document.getElementById('score-modal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }

        function createRoomMenu() {
            myName = document.getElementById('username').value;
            if(myName) socket.emit('createRoom', myName);
        }
        function joinRoomMenu() {
            myName = document.getElementById('username').value;
            if(myName) {
                document.getElementById('menu-screen').classList.add('hidden');
                document.getElementById('join-input-screen').classList.remove('hidden');
            }
        }
        function joinRoom() {
            const code = document.getElementById('room-code-input').value;
            socket.emit('joinRoom', { name: myName, roomId: code });
        }

        // --- SOCKET LOGIC ---
        socket.on('connect', () => { myId = socket.id; });

        socket.on('roomCreated', (id) => { myRoomId = id; enterLobby(id, true); });
        socket.on('roomJoined', (data) => { myRoomId = data.roomId; enterLobby(data.roomId, data.isHost); });
        
        function enterLobby(id, isHost) {
            hideAll();
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('display-room-code').innerText = id;
            if(isHost) document.getElementById('host-controls').classList.remove('hidden');
        }

        socket.on('updatePlayerList', (players) => {
            const list = players.map(p => 
                `<li style="padding:10px; background:#444; margin:5px; border-radius:5px; display:flex; justify-content:space-between;">
                    <span>${p.name} ${p.isSafe ? '‚úÖ (SAFE)' : ''}</span>
                    <span style="color:#ff4757; font-weight:bold;">${p.score} L</span>
                </li>`
            ).join('');
            document.getElementById('scoreboard-list').innerHTML = list;
        });

        // Setup Secret Phase
        function setGameRange() {
            socket.emit('setRange', { roomId: myRoomId, range: document.getElementById('grid-range').value });
        }
        
        socket.on('rangeSet', (range) => {
            hideAll();
            document.getElementById('secret-screen').classList.remove('hidden');
            createGrid(range, 'secret-grid', (num, div) => {
                document.querySelectorAll('#secret-grid .cell').forEach(c => c.classList.remove('selected'));
                div.classList.add('selected');
                socket.emit('selectSecret', { roomId: myRoomId, number: num });
            });
        });

        socket.on('allReady', () => document.getElementById('start-btn').classList.remove('hidden'));
        function triggerStartGame() { socket.emit('startGame', myRoomId); }

        // GAME PLAY
        socket.on('gameStarted', ({ range, firstPlayer, firstPlayerName }) => {
            hideAll();
            document.getElementById('game-screen').classList.remove('hidden');
            createGrid(range, 'main-grid', (num) => {
                socket.emit('cutNumber', { roomId: myRoomId, number: num });
            });
            updateTurnUI(firstPlayer, firstPlayerName);
        });

        socket.on('turnChange', ({ id, name }) => updateTurnUI(id, name));

        function updateTurnUI(id, name) {
            const msg = document.getElementById('turn-msg');
            const body = document.body;
            const grid = document.getElementById('main-grid');

            if(id === socket.id) {
                msg.innerText = "üëâ YOUR TURN (Cut a number)";
                msg.style.color = "#2ecc71";
                body.classList.add('my-turn-bg'); // Green Background
                grid.style.pointerEvents = 'auto';
            } else {
                msg.innerText = `‚è≥ Waiting for ${name}...`;
                msg.style.color = "#ccc";
                body.classList.remove('my-turn-bg');
                grid.style.pointerEvents = 'none';
            }
        }

        socket.on('timerUpdate', (t) => document.getElementById('timer').innerText = t);

        socket.on('numberCutResult', ({ number, safeNames }) => {
            const cell = document.querySelectorAll('#main-grid .cell')[number-1];
            if(cell) {
                if(safeNames.length > 0) {
                    cell.classList.add('safe-cut'); // Green because someone got safe
                    // alert(`${safeNames.join(', ')} is SAFE!`);
                } else {
                    cell.classList.add('normal-cut'); // Grey (Waste cut)
                }
            }
        });

        socket.on('roundOver', (msg) => {
            alert(msg);
            // Don't reload, wait for newRoundStart
        });

        socket.on('newRoundStart', () => {
            hideAll();
            // Reset background
            document.body.classList.remove('my-turn-bg');
            document.getElementById('secret-screen').classList.remove('hidden');
            document.getElementById('start-btn').classList.add('hidden');
            document.querySelector('#secret-screen h2').innerText = "New Round: Pick Secret";
            // Note: Grid will be regenerated by 'rangeSet' event from server immediately after this
        });

        // Utils
        function hideAll() {
            document.querySelectorAll('.container > div').forEach(d => d.classList.add('hidden'));
        }
        function createGrid(range, id, callback) {
            const con = document.getElementById(id); con.innerHTML='';
            for(let i=1; i<=range; i++) {
                const d = document.createElement('div');
                d.className = 'cell'; d.innerText=i;
                d.onclick = () => callback(i, d);
                con.appendChild(d);
            }
        }
    </script>
</body>
</html>
